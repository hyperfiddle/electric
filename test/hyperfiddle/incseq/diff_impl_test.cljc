(ns hyperfiddle.incseq.diff-impl-test
  (:require [clojure.test :refer [deftest is]]
            [hyperfiddle.incseq.diff-impl :as d]
            [hyperfiddle.incseq.perm-impl :as p]))

(deftest combine-simple
  (is (= (d/combine
           (d/diff [:a] 1 0 {})
           (d/diff [] 1 1 {}))
        (d/diff [] 0 0 {})))
  (is (= (d/combine
           (d/diff [:e] 4 2 (p/rotation 1 3))
           (d/diff [:f :g] 4 1 (p/rotation 3 1)))
        (d/diff [:f :g] 5 2 (p/split-swap 1 2 2))))
  (is (= (d/combine
           (d/diff [0 1 2 3 4 5 6 7 8 9 10 11 12 13] 54 0 {0 2, 7 14, 20 34, 27 41, 1 3, 24 38, 39 53, 46 10, 4 11, 15 28, 48 17, 50 22, 21 35, 31 45, 32 46, 40 0, 33 47, 13 25, 22 36, 36 50, 41 1, 43 7, 29 43, 44 8, 6 13, 28 42, 51 23, 25 39, 34 48, 17 31, 3 6, 12 24, 2 5, 23 37, 47 16, 35 49, 19 33, 11 21, 9 19, 5 12, 14 26, 45 9, 53 29, 26 40, 16 30, 38 52, 30 44, 10 20, 18 32, 52 27, 42 4, 37 51, 8 15, 49 18})
           (d/diff [] 54 37 {0 17, 7 23, 20 6, 27 9, 1 0, 24 33, 39 12, 46 47, 4 20, 15 29, 48 49, 21 7, 31 37, 32 38, 40 44, 33 39, 13 28, 22 31, 36 42, 41 13, 43 45, 29 10, 44 15, 6 22, 28 35, 25 8, 34 40, 17 4, 3 19, 12 27, 2 18, 23 32, 47 48, 35 41, 19 30, 11 26, 9 24, 5 21, 14 2, 45 46, 26 34, 16 3, 38 43, 30 36, 10 25, 18 5, 42 14, 37 11, 8 1, 49 16}))
        (d/diff [1 4 7 8 9 12 13] 47 30 {0 17, 7 2, 20 33, 27 13, 1 18, 24 36, 39 46, 46 10, 4 21, 15 28, 21 34, 31 39, 32 40, 40 0, 33 41, 13 8, 22 35, 36 43, 41 1, 43 4, 29 38, 44 5, 6 23, 28 14, 25 12, 34 42, 17 30, 3 20, 12 26, 2 19, 23 11, 35 16, 19 32, 11 7, 9 25, 5 22, 14 27, 45 9, 26 37, 16 29, 38 45, 30 15, 10 6, 18 31, 42 3, 37 44, 8 24})))
  (is (= (d/combine
           (d/diff (vec (range 37)) 54 0 {0 1, 7 21, 20 4, 27 12, 1 8, 24 9, 39 33, 46 45, 4 17, 15 44, 48 47, 21 5, 31 22, 32 23, 40 34, 33 24, 13 41, 22 6, 36 30, 41 35, 43 38, 29 15, 44 40, 6 20, 28 13, 25 10, 34 26, 17 0, 3 16, 12 39, 2 14, 23 7, 47 46, 35 28, 19 3, 11 37, 9 27, 5 18, 14 42, 45 43, 26 11, 16 49, 38 32, 30 19, 10 29, 18 2, 42 36, 37 31, 8 25, 49 48})
           (d/diff [] 54 54 {}))
        (d/diff [] 17 17 {}))))